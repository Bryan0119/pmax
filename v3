// copyright mike rhodes 2022
// for more resources, please visit agencysavvy.com
//
// outcome: build queries, grab data, push to sheet
//
// step 1: create a copy of this sheet first ********
// https://docs.google.com/spreadsheets/d/1bTYUnsrRzLtGov-ykt-KcJfzdCbvtevtZ8SrA2ZIgo0/copy
// enter url of YOUR sheet in line 16
//
// step 2: change the myCampaignNamingConvention on line 19 to match your account
//

function main() {

// enter url of your sheet here
  let ss = SpreadsheetApp.openByUrl('');   
  
// enter your naming convention for Performance Max campaigns here - report will be filtered for campaigns that include what you type
  let myCampaignNamingConvention = '';  // eg PMax or Performance or pMax pr Perf Max or pmax
  
  
  // don't change anything below this line *******************************************************
  
  
  // define commonly used query elements. wrap with spaces for safety
  let segDate = ' segments.date ';
  let title = ' segments.product_title ';
  let name = ' campaign.name ';
  let impr = ' metrics.impressions ';
  let clicks = ' metrics.clicks ';
  let cost = ' metrics.cost_micros ';
  let conv = ' metrics.conversions '; 
  let value = ' metrics.conversions_value '; 
  let views = ' metrics.video_views ';
  let cpv = ' metrics.average_cpv ';
  let agStrength = ' asset_group.ad_strength ';
  let agStatus = ' asset_group.status ';
  let agName = ' asset_group.name ';
  let lgName = ' asset_group_listing_group_filter.case_value.product_custom_attribute.value ';
  let lgType = ' asset_group_listing_group_filter.type ';

  let date_and_cost = ' segments.date DURING LAST_7_DAYS AND metrics.cost_micros > 0 ';
  let order = ' ORDER BY campaign.name';    // used to order by metrics.cost_micros DESC ';
  
  // build queries 
  let cd = [segDate, name, cost, conv, value, views, cpv] // views & cpv at campaign level
  let campQuery = 'SELECT ' + cd.join(',') + 
      ' FROM campaign ' +
      ' WHERE ' + date_and_cost + ' AND campaign.name LIKE "%'+ myCampaignNamingConvention +'%" ' + order ; // change to match campaign naming convention

  let pd = [segDate, name, title, cost, conv, value] // title & metrics from shopping perf view
  let prodQuery = 'SELECT ' + pd.join(',')  + 
      ' FROM shopping_performance_view  ' + 
      ' WHERE ' + date_and_cost + ' AND campaign.name LIKE "%'+ myCampaignNamingConvention +'%" ' + order ; // change to match campaign naming convention

  let ag = [segDate, name, agName, agStrength, agStatus, lgName, lgType, impr, clicks, cost, conv, value]   
  let agQuery = 'SELECT ' + ag.join(',')  + 
      ' FROM asset_group_product_group_view ' +
      ' WHERE segments.date DURING LAST_7_DAYS AND asset_group_listing_group_filter.type = "UNIT_INCLUDED" '
  
  
  // use report to get data
  runReport(campQuery, ss.getSheetByName('camp'));  
  runReport(prodQuery, ss.getSheetByName('prod')); 
  runReport(agQuery, ss.getSheetByName('ag')); 
}


// no need to clear sheet first, this just overwrites the whole tab
function runReport(q,sh) {
  const report = AdsApp.report(q);
  report.exportToSheet(sh);  
}
