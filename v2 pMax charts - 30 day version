// copyright mike rhodes 2022
// for more resources, please visit agencysavvy.com
//
// outcome: build queries, grab data, push to sheet - 30 day version
//
// step 1: create a copy of this sheet first https://docs.google.com/spreadsheets/d/1B7N1XbESpPhSbidtk7D3To2_2YTFeJqdTMzooN4sN5A/copy
// enter url of YOUR sheet in line 11 between the single quotes
//
// then change the naming convention on line 16 to match your pMax campaigns, again between the single quotes
//

function main() {

  let ss = SpreadsheetApp.openByUrl('');   // enter url of your sheet here
  
  let myCampaignNamingConvention = 'Performance';   // change as needed, eg pMax
  
  
  // don't change anything below this line *************************
  
  
  // define commonly used query elements. wrap with spaces for safety
  let segDate       = ' segments.date ';
  let title         = ' segments.product_title ';
  let cost          = ' metrics.cost_micros ';
  let name          = ' campaign.name ';
  let conv          = ' metrics.conversions '; 
  let value         = ' metrics.conversions_value '; 
  let views         = ' metrics.video_views ';
  let cpv           = ' metrics.average_cpv ';
  let date_and_cost = ' segments.date DURING LAST_30_DAYS AND metrics.cost_micros > 0 '; // 30 day version
  let order         = ' ORDER BY campaign.name ';   

  let cd = [segDate, name, cost, conv, value, views, cpv]
  let campDateQuery = 'SELECT ' + cd.join(',') + 
      ' FROM campaign ' +
      ' WHERE ' + date_and_cost + 
      ' AND campaign.name LIKE "%'+ myCampaignNamingConvention +'%" ' + order ; 

  let pd = [segDate, name, title, cost, conv, value]
  let prodDateQuery = 'SELECT ' + pd.join(',')  + 
      ' FROM shopping_performance_view  ' + 
      ' WHERE ' + date_and_cost + 
      ' AND campaign.name LIKE "%'+ myCampaignNamingConvention +'%" ' + order ; 

  runReport(campDateQuery, ss.getSheetByName('camp'));  
  runReport(prodDateQuery, ss.getSheetByName('prod')); 
}

function runReport(q,sh) {
  const report = AdsApp.report(q);
  report.exportToSheet(sh);  
}
